<%# app/views/user_messages/_assistant_actions.html.erb %>
<%# Expects: user_message %>

<%
  ai_message = user_message.ai_message
  chat = user_message.chat

  chat_enabled =
    if chat.respond_to?(:context_suggestions_enabled?)
      chat.context_suggestions_enabled?
    elsif chat.respond_to?(:context_suggestions_enabled)
      chat.context_suggestions_enabled != false
    else
      true
    end

  account_enabled =
    if current_user.respond_to?(:context_suggestions_enabled?)
      current_user.context_suggestions_enabled?
    elsif current_user.respond_to?(:context_suggestions_enabled)
      current_user.context_suggestions_enabled != false
    else
      true
    end

  context_enabled = chat_enabled && account_enabled
  latest = local_assigns.key?(:latest) ? !!local_assigns[:latest] : true
  actions = ai_message&.proposed_actions&.proposed&.order(created_at: :asc).to_a
  actions ||= []
  actions = actions.select { |a| a.action_type == "suggest_additional_context" }

  suggestions =
    if context_enabled
      actions.flat_map do |action|
        payload = action.payload.is_a?(Hash) ? action.payload : {}
        raw = Array(payload["suggestions"]) + Array(payload["questions"])
        if raw.empty?
          fallback =
            payload["prompt_template"].to_s.presence ||
            payload["title"].to_s.presence ||
            payload["subject"].to_s.presence
          raw << fallback if fallback.present?
        end

        raw
      end
    else
      []
    end

  normalize_suggestion = lambda do |value|
    s = value.to_s.tr("“”", "\"").tr("‘’", "'").squish
    s = s.sub(/\A["']+/, "").sub(/["']+\z/, "")
    s = s.sub(/\s+["']\z/, "")
    s.strip
  end

  low_signal_suggestion = lambda do |value|
    s = value.to_s.downcase
    return true if s.blank?
    return true if s.include?("single-sentence confirmation")
    return true if s.match?(/\bok\?\s*\z/)
    return true if s.match?(/\bconfirm(?:ation)?\b/) && s.match?(/\b(already|current|existing|same|above|this)\b/)
    false
  end

  current_instruction = user_message.instruction.to_s.squish.downcase

  suggestions = suggestions
    .map { |s| normalize_suggestion.call(s) }
    .reject(&:blank?)
    .reject { |s| s.downcase == current_instruction }
    .reject { |s| low_signal_suggestion.call(s) }
    .uniq
    .first(2)

  should_render = latest && (suggestions.any? || !context_enabled)
%>

<% if should_render %>
  <div
    class="assistant-actions <%= "is-disabled" unless context_enabled %>">

    <% if context_enabled && suggestions.any? %>
      <div class="assistant-actions__header">
        <div class="assistant-actions__title">Suggested follow-ups</div>
        <div class="assistant-actions__subtitle">Tap to insert into composer</div>
      </div>

      <div class="assistant-actions__content">
        <div class="assistant-actions__list">
          <% suggestions.each do |suggestion| %>
            <button
              type="button"
              class="assistant-suggestion"
              data-controller="composer-suggestion"
              data-action="click->composer-suggestion#insert"
              data-composer-suggestion-text-value="<%= suggestion %>">
              <span class="assistant-suggestion__label"><%= suggestion %></span>
              <span class="assistant-suggestion__cta">Use</span>
            </button>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="assistant-actions__status">
        <% if account_enabled %>
          Suggestions are off for this chat.
        <% else %>
          Suggestions are off for all chats.
        <% end %>
      </div>
    <% end %>

    <div class="assistant-actions__footer">
      <%= button_to(
            (chat_enabled ? "Hide in this chat" : "Show in this chat"),
            toggle_context_suggestions_chat_path(chat),
            method: :patch,
            params: { scope: "chat", enabled: (!chat_enabled), user_message_id: user_message.id },
            class: "btn btn-secondary btn-small",
            form: { data: { turbo_stream: true } }
          ) %>

      <%= button_to(
            (account_enabled ? "Hide in all chats" : "Show in all chats"),
            toggle_context_suggestions_chat_path(chat),
            method: :patch,
            params: { scope: "account", enabled: (!account_enabled), user_message_id: user_message.id },
            class: "btn btn-secondary btn-small",
            form: { data: { turbo_stream: true } }
          ) %>
    </div>
  </div>
<% end %>
