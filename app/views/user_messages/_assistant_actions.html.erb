<%# app/views/user_messages/_assistant_actions.html.erb %>
<%# Expects: user_message %>

<%
  ai_message = user_message.ai_message
  chat = user_message.chat

  context_enabled =
    if chat.respond_to?(:context_suggestions_enabled?)
      chat.context_suggestions_enabled?
    elsif chat.respond_to?(:context_suggestions_enabled)
      chat.context_suggestions_enabled != false
    else
      true
    end

  latest = local_assigns.key?(:latest) ? !!local_assigns[:latest] : true
  actions = ai_message&.proposed_actions&.proposed&.order(created_at: :asc).to_a
  actions ||= []
  actions = actions.select { |a| a.action_type == "suggest_additional_context" }

  suggestions =
    if context_enabled
      actions.flat_map do |action|
        payload = action.payload.is_a?(Hash) ? action.payload : {}
        raw = Array(payload["suggestions"]) + Array(payload["questions"])
        if raw.empty?
          fallback =
            payload["prompt_template"].to_s.presence ||
            payload["title"].to_s.presence ||
            payload["subject"].to_s.presence
          raw << fallback if fallback.present?
        end

        raw
      end
    else
      []
    end

  suggestions = suggestions.map { |s| s.to_s.squish }.reject(&:blank?).uniq.first(2)
  should_render = latest && (suggestions.any? || !context_enabled)
%>

<% if should_render %>
  <div class="assistant-actions">
    <% if suggestions.any? %>
      <div class="assistant-actions__list">
        <% suggestions.each do |suggestion| %>
          <button
            type="button"
            class="assistant-suggestion"
            data-controller="composer-suggestion"
            data-action="click->composer-suggestion#insert"
            data-composer-suggestion-text-value="<%= suggestion %>">
            <span class="assistant-suggestion__label"><%= suggestion %></span>
            <span class="assistant-suggestion__cta">Use</span>
          </button>
        <% end %>
      </div>
    <% elsif !context_enabled %>
      <div class="assistant-actions__empty">Suggestions dismissed for this chat.</div>
    <% end %>

    <div class="assistant-actions__footer">
      <%= button_to(
            (context_enabled ? "Dismiss suggestions" : "Show suggestions"),
            toggle_context_suggestions_chat_path(chat),
            method: :patch,
            params: { enabled: (!context_enabled), user_message_id: user_message.id },
            class: "btn btn-secondary btn-small",
            form: { data: { turbo_stream: true } }
          ) %>
    </div>
  </div>
<% end %>
