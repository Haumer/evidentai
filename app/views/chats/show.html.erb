<%# app/views/chats/show.html.erb %>

<%= turbo_stream_from @chat %>

<div class="chat-layout" data-controller="stream-recover" data-stream-recover-chat-id-value="<%= @chat.id %>">

  <!-- LEFT: Chat -->
  <section class="chat-pane">
    <div class="chat <%= 'is-empty' if @user_messages.blank? %>" data-controller="chat-scroll">
      <header class="chat-header">
        <%= render partial: "chats/title", locals: { chat: @chat } %>
        <div class="chat-meta">
          <span class="pill"><%= @chat.status.presence || "active" %></span>
        </div>
      </header>

      <!-- Timeline -->
      <div class="chat-timeline" data-chat-scroll-target="timeline">
        <div class="chat-inner" id="chat_timeline">
          <% if @user_messages.blank? %>
            <div class="empty-state">
              <h2>Start by typing a prompt</h2>
              <p class="muted">Your first message will start this chat.</p>
            </div>
          <% end %>

          <% latest_user_message_id = @user_messages.last&.id %>
          <% @user_messages.each do |user_message| %>
            <%= render partial: "user_messages/row",
                       locals: { user_message: user_message, latest_user_message_id: latest_user_message_id } %>
          <% end %>
        </div>
      </div>

      <!-- Composer -->
      <div class="composer">
        <div class="chat-inner">
          <%= form_with model: @user_message,
                url: chat_user_messages_path(@chat),
                local: false,
                class: "composer-form",
                data: {
                  controller: "submit-on-enter",
                  action: "keydown->submit-on-enter#keydown",
                  submit_on_enter_chat_id_value: @chat.id
                } do |f| %>

            <div class="composer-input">
              <%= f.text_area :instruction,
                    id: "composer_instruction",
                    rows: 2,
                    placeholder: "Messageâ€¦ (Enter to send, Shift+Enter for newline)",
                    class: "composer-textarea",
                    data: { "submit-on-enter-target": "input" } %>
            </div>

            <div class="composer-actions" id="composer_actions">
              <%= render "chats/composer_actions" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT: Output / Artifact -->
  <aside class="artifact-pane">
    <div id="artifact_live">
      <!-- STABLE TARGET: must ALWAYS exist -->
      <%= turbo_frame_tag "artifact_content" do %>
        <%= render partial: "chats/artifact_preview",
                   locals: {
                     text: @artifact_text,
                     status: (@artifact_text.present? ? "draft" : "waiting"),
                     chat: @chat,
                     artifact: @artifact
                   } %>
      <% end %>
    </div>
  </aside>


</div>
