<%# app/views/chats/_artifact_preview.html.erb %>

<%
  status ||= "waiting"
  status = status.to_s
  has_text = text.to_s.strip.present?

  chat =
    local_assigns[:chat] ||
    (defined?(@chat) && @chat)

  # Resolve artifact reliably (Turbo broadcasts don't set controller ivars)
  artifact =
    local_assigns[:artifact] ||
    (defined?(@artifact) && @artifact)

  if artifact.blank?
    artifact = Artifact.where(chat_id: chat.id).order(created_at: :desc).first if chat.present?
  end

  versions =
    if chat.present?
      Artifact.where(chat_id: chat.id).order(created_at: :desc).to_a
    else
      []
    end

  if versions.empty? && artifact.present?
    versions = [artifact]
  end

  current_artifact = artifact || versions.first
  current_index = versions.index { |v| v.id == current_artifact&.id } || 0
  total_versions = versions.size
  current_number = total_versions.zero? ? 0 : (total_versions - current_index)

  older_artifact = (current_index + 1 < total_versions) ? versions[current_index + 1] : nil
  newer_artifact = current_index.positive? ? versions[current_index - 1] : nil

  # Dataset discovery (no iframe JS; server-side parse only)
  # Prefer persisted dataset_json if available; fallback to parsing the HTML.
  extracted = has_text ? Ai::Artifacts::Dataset::Extract.call(text) : { dataset_json: nil, sources_json: nil }

  dataset_payload =
    if artifact&.respond_to?(:dataset_json) && artifact.dataset_json.present?
      artifact.dataset_json
    else
      extracted[:dataset_json]
    end

  datasets = dataset_payload.is_a?(Hash) ? (dataset_payload["datasets"] || []) : []
  datasets = [] unless datasets.is_a?(Array)
  has_datasets = datasets.any?

  dataset_locked =
    artifact&.respond_to?(:dataset_locked_by_user?) ? artifact.dataset_locked_by_user? : false

  # IMPORTANT:
  # Keep dataset OUTSIDE the iframe.
  iframe_text = has_text ? Ai::Artifacts::Dataset::Strip.call(text) : ""
%>

<header class="artifact-header">
  <div class="artifact-header-left">
    <h2 class="artifact-title">Output</h2>
    <div class="artifact-subtitle">
      <%= has_text ? "Most recent version" : "Ready for your first request" %>
    </div>
  </div>

  <div class="artifact-header-right">
    <% if total_versions.positive? %>
      <div class="artifact-version-nav" aria-label="Artifact versions">
        <% if older_artifact.present? && chat.present? %>
          <%= link_to "‹",
                      artifact_preview_chat_path(chat, artifact_id: older_artifact.id),
                      class: "artifact-version-arrow",
                      data: { turbo_frame: "artifact_content" } %>
        <% else %>
          <span class="artifact-version-arrow is-disabled">‹</span>
        <% end %>

        <span class="artifact-version-count"><%= "#{current_number}/#{total_versions}" %></span>

        <% if newer_artifact.present? && chat.present? %>
          <%= link_to "›",
                      artifact_preview_chat_path(chat, artifact_id: newer_artifact.id),
                      class: "artifact-version-arrow",
                      data: { turbo_frame: "artifact_content" } %>
        <% else %>
          <span class="artifact-version-arrow is-disabled">›</span>
        <% end %>
      </div>
    <% end %>

    <% if dataset_locked %>
      <span class="pill is-muted" title="This dataset has been edited. AI updates will not overwrite it.">
        Data edited
      </span>
    <% end %>

    <%= render partial: "chats/artifact_status_pill", locals: { status: status, has_text: has_text } %>
  </div>
</header>

<div class="artifact-inner <%= "has-sheets" if has_datasets %>">
  <% if has_text %>
    <%# CRITICAL: this partial must wrap the iframe in turbo_frame_tag "artifact_iframe"
        so CellsController can turbo_stream.replace("artifact_iframe", ...) %>
    <%= render partial: "chats/artifact_iframe", locals: { artifact: artifact, text: iframe_text } %>
  <% else %>
    <div class="artifact-empty-card">
      <h3>Output Will Appear Here</h3>
      <p class="muted">Ask for a draft, summary, or plan and it will render in this pane.</p>

      <div class="artifact-empty-minimal" aria-hidden="true">
        <div class="artifact-empty-minimal__mark">
          <span></span>
        </div>
      </div>
    </div>
  <% end %>
</div>

<%# Bottom "Sheets" bar (only when dataset is present) %>
<% if has_datasets %>
  <%= render partial: "chats/artifact_sheets", locals: { artifact: artifact, chat: (defined?(@chat) && @chat), datasets: datasets } %>
<% end %>
