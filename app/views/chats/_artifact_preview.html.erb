<%# app/views/chats/_artifact_preview.html.erb %>

<%
  status ||= "waiting"
  status = status.to_s
  is_working = (status == "working")
  has_text = text.to_s.strip.present?

  # Resolve artifact reliably (Turbo broadcasts don't set controller ivars)
  artifact =
    local_assigns[:artifact] ||
    (defined?(@artifact) && @artifact)

  if artifact.blank?
    chat =
      local_assigns[:chat] ||
      (defined?(@chat) && @chat)
    artifact = Artifact.where(chat_id: chat.id).order(created_at: :desc).first if chat.present?
  end

  # Dataset discovery (no iframe JS; server-side parse only)
  # Prefer persisted dataset_json if available; fallback to parsing the HTML.
  extracted = has_text ? Ai::ArtifactDatasetExtractor.call(text) : { dataset_json: nil, sources_json: nil }

  dataset_payload =
    if artifact&.respond_to?(:dataset_json) && artifact.dataset_json.present?
      artifact.dataset_json
    else
      extracted[:dataset_json]
    end

  datasets = dataset_payload.is_a?(Hash) ? (dataset_payload["datasets"] || []) : []
  datasets = [] unless datasets.is_a?(Array)
  has_datasets = datasets.any?

  dataset_locked =
    artifact&.respond_to?(:dataset_locked_by_user?) ? artifact.dataset_locked_by_user? : false

  # IMPORTANT:
  # Keep dataset OUTSIDE the iframe.
  iframe_text = has_text ? Ai::ArtifactDatasetStripper.call(text) : ""
%>

<header class="artifact-header">
  <div class="artifact-header-left">
    <h2 class="artifact-title">Output</h2>
    <div class="artifact-subtitle">
      <% if is_working %>
        <%= has_text ? "Updating…" : "Generating…" %>
      <% else %>
        <%= has_text ? "" : "No output yet" %>
      <% end %>
    </div>
  </div>

  <div class="artifact-header-right">
    <% if dataset_locked %>
      <span class="pill is-muted" title="This dataset has been edited. AI updates will not overwrite it.">
        Data edited
      </span>
    <% end %>

    <% if is_working %>
      <div class="artifact-working is-active" aria-live="polite">
        <span class="artifact-spinner" aria-hidden="true"></span>
        <span class="artifact-working-text">Generating…</span>
      </div>
    <% end %>

    <span class="pill <%= "is-live" if has_text %> <%= "is-working" if is_working %>">
      <span class="pill-dot"></span>
      <%= is_working ? "working" : (has_text ? "ready" : "waiting") %>
    </span>
  </div>
</header>

<div class="artifact-inner <%= "has-sheets" if has_datasets %>">
  <% if has_text %>
    <%# CRITICAL: this partial must wrap the iframe in turbo_frame_tag "artifact_iframe"
        so CellsController can turbo_stream.replace("artifact_iframe", ...) %>
    <%= render partial: "chats/artifact_iframe", locals: { artifact: artifact, text: iframe_text } %>
  <% else %>
    <div class="artifact-empty-card">
      <h3>No output yet</h3>
      <p class="muted">As you chat, the generated result will appear here.</p>

      <div class="artifact-skeleton" aria-hidden="true">
        <div class="skel-line w-70"></div>
        <div class="skel-line w-90"></div>
        <div class="skel-line w-55"></div>
        <div class="skel-line w-75"></div>
      </div>
    </div>
  <% end %>
</div>

<%# Bottom "Sheets" bar (only when dataset is present) %>
<% if has_datasets %>
  <%= render partial: "chats/artifact_sheets", locals: { artifact: artifact, chat: (defined?(@chat) && @chat), datasets: datasets } %>
<% end %>
