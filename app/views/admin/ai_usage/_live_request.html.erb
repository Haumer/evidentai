<% user_id = usage.user_message&.created_by_id || usage.chat&.created_by_id || usage.metadata["actor_user_id"] || usage.metadata[:actor_user_id] %>
<% chat_id = usage.chat_id || usage.metadata["chat_id_snapshot"] || usage.metadata[:chat_id_snapshot] %>
<% status = usage.status.to_s.presence || "completed" %>
<% status_label = status == "running" ? "Running" : (status == "failed" ? "Failed" : "Done") %>
<% started_at = usage.requested_at || usage.created_at || Time.current %>

<article id="<%= dom_id(usage, :live) %>" class="admin-live-feed__item is-<%= status %>">
  <div class="admin-live-feed__topline">
    <span class="admin-live-feed__time"><%= usage.requested_at&.strftime("%H:%M:%S") || "—" %></span>
    <span class="admin-live-feed__kind"><%= usage.request_kind.to_s.tr("_", " ").titleize %></span>
  </div>

  <div class="admin-live-feed__line">
    <span class="admin-live-feed__state" aria-hidden="true"></span>
    <strong><%= usage.model.presence || "Unknown model" %></strong>
    <% if status == "running" %>
      <span
        class="admin-live-feed__status-text admin-live-feed__status-text--timer"
        data-controller="elapsed-timer"
        data-elapsed-timer-prefix-value="Running"
        data-elapsed-timer-started-at-value="<%= started_at.to_time.iso8601(3) %>">
        Running
      </span>
    <% else %>
      <span class="admin-live-feed__status-text"><%= status_label %></span>
    <% end %>
  </div>

  <div class="admin-live-feed__line muted">
    <span>User #<%= user_id || "—" %></span>
    <span>Chat #<%= chat_id || "—" %></span>
    <span><%= number_with_delimiter(usage.total_tokens) %> tok</span>
    <span><%= number_to_currency(usage.total_cost_usd, unit: "$") %></span>
  </div>
</article>
