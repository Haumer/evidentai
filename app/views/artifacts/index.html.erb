<%# app/views/artifacts/index.html.erb %>

<section class="artifacts-index">
  <header class="artifacts-index__header">
    <h1>Artifacts</h1>
    <p>Latest artifact from each chat.</p>
  </header>

  <% if @artifacts.any? %>
    <div class="artifacts-grid">
      <% @artifacts.each do |artifact| %>
        <%
          raw_text =
            if artifact.respond_to?(:content) && artifact.content.present?
              artifact.content.is_a?(Hash) ? artifact.content["text"].to_s : artifact.content.to_s
            elsif artifact.respond_to?(:data) && artifact.data.present?
              artifact.data.is_a?(Hash) ? artifact.data["text"].to_s : artifact.data.to_s
            elsif artifact.respond_to?(:body) && artifact.body.present?
              artifact.body.to_s
            elsif artifact.respond_to?(:text) && artifact.text.present?
              artifact.text.to_s
            else
              ""
            end

          preview_html = raw_text.present? ? Ai::Artifacts::Dataset::Strip.call(raw_text) : ""
          srcdoc = preview_html.present? ? Ai::Links::Harden.call(preview_html, target_blank: true) : ""
          chat_title = artifact.chat.title.to_s.strip.presence || "Untitled chat"
        %>

        <article class="artifact-card">
          <%= link_to "", chat_path(artifact.chat), class: "artifact-card__open", aria: { label: "Open #{chat_title}" } %>

          <div class="artifact-card__thumb">
            <% if srcdoc.present? %>
              <iframe
                class="artifact-card__frame"
                sandbox="allow-popups allow-popups-to-escape-sandbox"
                referrerpolicy="no-referrer"
                srcdoc="<%= srcdoc %>">
              </iframe>
            <% else %>
              <div class="artifact-card__empty">No preview yet</div>
            <% end %>
          </div>

          <div class="artifact-card__caption">
            <div class="artifact-card__sub">Updated <%= time_ago_in_words(artifact.created_at) %> ago</div>
          </div>
        </article>
      <% end %>
    </div>
  <% else %>
    <div class="artifact-index-empty">
      <h2>No artifacts yet</h2>
      <p>Create output in a chat and it will show up here.</p>
    </div>
  <% end %>
</section>
